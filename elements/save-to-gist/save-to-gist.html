<dom-module id="save-to-gist">
    <template>
        <iron-ajax
            id="authenticator"
            url="https://github.com/login/oauth/access_token"
            on-success="_handleToken"
            method="POST"
            withCredentials="true"
            ></iron-ajax>
        <template is="dom-if" if="{{code}}">
            Save to gist
        </template>
        <template is="dom-if" if="{{!code}}">
            <div on-click="_authenticateGithub">Login</div>
        </template>
    </template>
    <script>
        Polymer({
            is: 'save-to-gist',
            properties: {
                 client_id: String,
                 client_secret: String,
                 redirect_endpoint: {
                    type: String,
                    value: ''
                  },
                  scope: String,
                  origin: String,
                  token: {
                      type: String,
                      value: ''
                  }
            },
            ready: function() {
                console.log('Save to gist is ready', this._getQueryVariable('code'));
                this.code =  this._getQueryVariable('code');
                if(this.code) {
                    this._getToken();
                }

            },
            _getToken: function() {
                var params = {
                    client_id: this.client_id,
                    client_secret: this.client_secret,
                    code: this.code
                }
                this.$.authenticator.params = params;
                this.$.authenticator.generateRequest();
            },
            _getQueryVariable: function(variable) {
               var query = window.location.search.substring(1);
               var vars = query.split("&");
               for (var i=0;i<vars.length;i++) {
                       var pair = vars[i].split("=");
                       if(pair[0] == variable){return pair[1];}
               }
               return(false);
            },
            _handleToken: function(e) {
                console.log(e);
            },
            _authenticateGithub: function() {
                var location = 'https://github.com/login/oauth/authorize?client_id=' +
                          this.client_id + '&redirect_uri=' +
                          this.origin + this.redirect_endpoint +
                          '&scope=' + this.scope;

                window.open(location, 'GITHUB_SIGNIN_ELEMENT');
            }
        })
    </script>
</dom-module>