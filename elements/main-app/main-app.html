<dom-module id="main-app">
    <template>
        <style>
            :host {

            }
            paper-toolbar {
                --paper-toolbar-background: rgba(0,0,0,0.7);
                --paper-toolbar-title: {
                  margin-left: 0px;
                  font-size: 15px;
                }
              }
            .main-container {
                @apply(--layout-horizontal);
                height: calc(100vh - 84px);
            }
            .live-preview-section {

               @apply(--layout-flex);
                height: calc(100vh - 84px);
            }
            live-preview {
                margin: 10px 0 20px 10px;
                @apply(--layout-self-stretch);
            }

            .code-editor-section, .svg-keyframe-section {
                @apply(--layout-vertical);
                height: calc(100vh - 84px);
            }
            .code-editor-section {
                overflow-y: hidden;
                margin-top: 10px;
            }
            .svg-keyframe-section {
                padding: 10px;
                overflow-y: hidden;
                @apply(--layout-vertical);
            }
            .svg-keyframe-collection {
                @apply(--layout-vertical);
                overflow-y: scroll;
                display: block;
                height: 100vh;
            }
            .add-keyframe-section {
                display: block;
            }
            code-editor:nth-child(2) {
                border-top: 2px solid #434343;
                z-index: 3;
            }
            svg-keyframe {
                margin-bottom: 20px;
            }
            .add-keyframe-section paper-button {
                background: rgba(0,0,0,0.7);
                color: white;
                width: 100%;
                margin: 20px 0 0;
            }
            paper-dialog {
                width: 300px;
            }
            paper-input {
                margin: 20px;
            }
        </style>
        <paper-toolbar>
            <div class="title">
              @SVG2CSS
            </div>
            <paper-icon-button icon="refresh" on-click="updateLivePreview"></paper-icon-button>
            <save-to-gist
                files={{files}}
                client_id="15f3d642904a6a95f0f6"
                client_secret="efe69472650c3a0420311b64fcfd4d64982d6fd6"
                scope="gist"
                origin="https://svg2css-prateekjadhwani.c9users.io/index.html"></save-to-gist>
        </paper-toolbar>
        <div class="main-container">
            <div class="live-preview-section">
                <live-preview class="horizontal layout"></live-preview>
            </div>

            <div class="code-editor-section">
                <code-editor mode="css"></code-editor>
                <code-editor mode="xml"></code-editor>
            </div>
            <div class="svg-keyframe-section">
                <div class="svg-keyframe-collection">
                    <svg-keyframe keyframe-name="dropball"></svg-keyframe>
                </div>
                <div class="add-keyframe-section">
                    <paper-button raised on-click="handleAddSvgKeyframe">Add More Keyframes</paper-button>
                </div>
            </div>
        </div>
        <paper-dialog>
          <h2>New @keyframe</h2>
          <paper-dialog-scrollable>
            <paper-input label="@keyframe name" id="newkeyframe"></paper-input>
          </paper-dialog-scrollable>
          <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button dialog-confirm on-click="addSvgKeyframe">Add</paper-button>
          </div>
        </paper-dialog>
    </template>
    <script>
        Polymer({
            is: 'main-app',
            properties: {
                files: {
                    type: Object,
                    notify: true,
                    value: {}
                }
            },
            ready: function() {

            },
            updateLivePreview: function() {
                var data = this._getUpdatedCodeFromElements();
                this.$$('live-preview').updateLivePreview(data);
            },
            _getUpdatedCodeFromElements: function() {
                var codeEl = this.$$('.code-editor-section').querySelectorAll('code-editor'),
                    keyFramesEl = this.$$('.svg-keyframe-collection').querySelectorAll('svg-keyframe'),
                    styles = '',
                    htmls  = '';

                // Get codes from editors
                for(var i=0; i<codeEl.length; i++) {
                    var mode = codeEl[i].getAttribute('mode'),
                        code = codeEl[i].innerCode;
                    if(mode == 'css') {
                        styles += code;
                    } else {
                        htmls += code;
                    }
                }
                this._addToFiles('base.css', styles);
                this._addToFiles('index.html', htmls);

                // Get Codes from svg-keyframes
                var keyframeCodes = '';
                for(var i=0; i<keyFramesEl.length; i++) {
                    var code = keyFramesEl[i].builtCss;
                    keyframeCodes += code;
                }
                styles += keyframeCodes;
                this._addToFiles('animations.css', keyframeCodes);

                return {
                    styles: styles,
                    htmls: htmls
                }
            },
            _addToFiles: function(name, content) {
                var fileObj = {
                    'content': content
                }
                this.files[name] = fileObj;
            },
            handleAddSvgKeyframe: function() {
                this.$$('paper-dialog').open();
            },
            addSvgKeyframe: function() {
                var newSvgKeyframe = document.createElement('svg-keyframe');
                newSvgKeyframe.setAttribute('keyframe-name', this.$.newkeyframe.value);
                newSvgKeyframe.style.marginBottom = "20px";
                this.$$('.svg-keyframe-collection').appendChild(newSvgKeyframe);
            }
        });
    </script>
</dom-module>